<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta Content-Security-Policy-Report-Only: script-src
    https://accounts.google.com/gsi/client; frame-src
    https://accounts.google.com/gsi/; connect-src
    https://accounts.google.com/gsi/; />
    <meta property="og:title" content="Sign In to Access Your Account" />
    <meta
      property="og:description"
      content="Sign in to access your account and enjoy personalized features."
    />
    <meta property="og:image" content="./images/auth.jpg" />
    <meta property="og:url" content="https://truecontento.com" />

    <link rel="stylesheet" href="bootstrap-5.0.2-dist/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="css/auth.css" />
    <link rel="icon" type="image/x-icon" href="/images/logo_48.png" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <title>TrueContento - Auth</title>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RJJBWMBPE4"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-RJJBWMBPE4");
    </script>
  </head>
  <body>
    <nav
      class="navbar sticky-top navbar-expand-lg navbar-dark"
      style="
        background-color: #0061c2;
        font-size: 1.2rem;
        box-shadow: 0px 4px 30px #1b1b1b4b;
      "
      id="navbar"
    >
      <div class="container">
        <a class="navbar-brand" href="/">TrueContento</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse justify-content-between"
          id="navbarNav"
        >
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/pricing.html">Pricing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/referral.html">Referral</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/#contact">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <main>
      <div class="container">
        <div class="row m-3">
          <h1 class="display-2">
            Welcome <span class="background-text">back</span>
          </h1>
          <div class="col-sm" id="welcome">
            <div id="loginForm" class="m-3">
              <div class="mb-3">
                <p for="email" class="form-label">Email address</p>
                <input
                  type="email"
                  class="form-control auth-input"
                  name="email"
                  id="email"
                  aria-describedby="emailHelp"
                  placeholder="example@gmail.com"
                  required
                />
                <div id="emailHelp" class="form-text">
                  Your email will not be shared with anyone else.
                </div>
                <div class="mb-1 mt-1" id="emailErrDiv"></div>
              </div>

              <div class="mb-3" id="eye">
                <p for="password" class="form-label">Password</p>
                <div class="row">
                  <div class="col-11">
                    <input
                      type="password"
                      class="form-control auth-input"
                      id="password"
                      name="password"
                      required
                    />
                  </div>
                  <i class="col-1 bi bi-eye-slash" id="togglePassword"></i>
                </div>
                <div class="mb-1 mt-1" id="passErrDiv"></div>
              </div>
              <button
                type="submit"
                onclick="standardLogin()"
                class="btn btn-outline-dark rounded-pill"
                style="width: 260px"
              >
                Sign-in / Sign-up
              </button>
              <div class="mb-1 mt-1" id="errDiv"></div>
              <br />
              <p>Or continue with</p>
              <div>
                <div
                  id="g_id_onload"
                  data-client_id="678344678635-ob6vtiud5itdbnp5rdgrnp89krcpe9ev.apps.googleusercontent.com"
                  data-context="signin"
                  data-ux_mode="popup"
                  data-callback="handleCredentialResponse"
                  data-nonce=""
                  data-auto_select="true"
                  data-itp_support="true"
                ></div>
                <div
                  class="g_id_signin"
                  data-type="standard"
                  data-shape="pill"
                  data-theme="outline"
                  data-text="signin_with"
                  data-size="large"
                  data-width="260"
                  data-logo_alignment="center"
                ></div>
              </div>
              <div class="mt-4">
                <label class="form-text">
                  <input type="checkbox" id="terms-checkbox" checked />
                  I agree to the
                  <a href="./policy/terms-of-service.html" target="_blank"
                    >Terms of Service
                  </a>
                  and
                  <a href="./policy/privacy-policy.html" target="_blank">
                    Privacy Policy</a
                  >
                </label>
              </div>
              <div class="mb-1 mt-1" id="privacyErr"></div>
            </div>
          </div>
          <div class="col-sm pt-1">
            <img
              class="img-fluid max-width: 80%"
              src="./images/cwok_casual_19.png"
              alt="home image"
            />
          </div>
        </div>
      </div>
    </main>
    <script>
      const togglePassword = document.querySelector("#togglePassword");
      const password = document.querySelector("#password");

      togglePassword.addEventListener("click", function () {
        // toggle the type attribute
        const type =
          password.getAttribute("type") === "password" ? "text" : "password";
        password.setAttribute("type", type);

        // toggle the icon
        this.classList.toggle("bi-eye");
      });
      // standard login
      function standardLogin() {
        var policyCheckbox = document.getElementById("terms-checkbox");
        if (!policyCheckbox.checked) {
          var errDiv2 = document.getElementById("privacyErr");
          errDiv2.innerHTML =
            '<div class="my-alert">You must agree with our policies</div>';
          return;
        }
        // validate intput
        var emailInput = document.getElementById("email");
        var passwordInput = document.getElementById("password");

        if (!emailInput.value) {
          var errDiv = document.getElementById("emailErrDiv");
          errDiv.innerHTML =
            '<div class="my-alert">Email must not be empty!</div>';
          return;
        }
        var emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

        // Testiraj email adresu koristeÄ‡i regex
        if (!emailRegex.test(emailInput.value)) {
          var errDiv = document.getElementById("emailErrDiv");
          errDiv.innerHTML = `<div class="my-alert">
            Email format is not valid!
          </div>`;
          return;
        }

        if (!passwordInput.value) {
          var errDiv = document.getElementById("passErrDiv");
          errDiv.innerHTML =
            '<div class="my-alert">Password must not be empty!</div>';
          return;
        }

        if (passwordInput.value.length < 6) {
          var errDiv = document.getElementById("passErrDiv");
          errDiv.innerHTML =
            '<div class="my-alert">Password must be at least 6 characters long!</div>';
          return;
        }

        localStorage.setItem("login-type", "standard");
        event.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const referral = localStorage.getItem("referral");
        fetch("/auth.html", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Login-Type": "standard",
          },
          body: JSON.stringify({ email, password, referral }),
        })
          .then((response) => {
            console.log(response);

            if (response.status == 200) {
              return response.json();
            } else if (response.status == 401) {
              throw new Error("Credentials incorrect!");
            } else if (response.status == 201) {
              var errDiv = document.getElementById("errDiv");
              errDiv.innerHTML =
                '<div class="my-alert">Your email needs to be verified, a verification email has been sent. Check your spam!</div>';
              return response.json();
            } else if (response.status == 403) {
              throw new Error(
                "You have not verified your email yet. Check your inbox for a verification link."
              );
            } else if (response.status == 500) {
              throw new Error("Account already exists as google account!");
            }
          })
          .then((data) => {
            console.log("Login successful.");
            console.log(data);
            if ("userToken" in data) {
              console.log("Unverified user tried to log-in.");
            } else {
              console.log("Verified user has logged in.");
              localStorage.setItem("token", data.token);
              localStorage.setItem("email", data.email);
              localStorage.setItem("profilePic", data.profilePic);
              localStorage.setItem("availableCredits", data.availableCredits);
              const currentPath = window.location.pathname;
              // ne gadjamo rutu /generate-video vec direktno idemo na fajl jer je vec logovan
              const newPath = currentPath.replace(
                "/auth.html",
                "/generate-video.html"
              );
              window.location.replace(newPath);
              console.log("Should redirect to another page.");
            }
          })
          .catch((error) => {
            // handle error
            var errDiv = document.getElementById("errDiv");
            errDiv.innerHTML =
              '<div class="my-alert">' + error.message + "</div>";
          });
      }
      // google login
      function handleCredentialResponse(response) {
        var policyCheckbox = document.getElementById("terms-checkbox");
        if (!policyCheckbox.checked) {
          var errDiv2 = document.getElementById("privacyErr");
          errDiv2.innerHTML =
            '<div class="my-alert">You must agree with our policies</div>';
          return;
        }

        localStorage.setItem("login-type", "google");
        const referral = localStorage.getItem("referral");
        // Create XMLHttpRequest object
        const xhr = new XMLHttpRequest();
        // Set up request
        xhr.open("POST", "/auth.html", true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Login-Type", "google");
        // Send user data to backend
        xhr.send(
          JSON.stringify({
            clientId: response.clientId,
            credential: response.credential,
            referral: referral,
          })
        );
        // Handle response from backend
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              const data = JSON.parse(xhr.response);
              console.log(data);
              console.log("Data sent to backend successfully");
              localStorage.setItem("token", data.token);
              localStorage.setItem("email", data.email);
              localStorage.setItem("profilePic", data.profilePic);
              localStorage.setItem("availableCredits", data.availableCredits);
              const currentPath = window.location.pathname;
              // ne gadjamo rutu /generate-video vec direktno idemo na fajl jer je vec logovan
              const newPath = currentPath.replace(
                "/auth.html",
                "/generate-video.html"
              );
              window.location.replace(newPath);
            } else if (xhr.status === 401) {
              const data = JSON.parse(xhr.response);
              var errDiv = document.getElementById("errDiv");
              errDiv.innerHTML =
                '<div class = "alert alert-danger" role = "alert">' +
                data.msg +
                "</div>";
            } else {
              console.log("Error sending data to backend: " + xhr.statusText);
            }
          }
        };

        // console.log("ID: " + responsePayload.sub);
        // console.log('Full Name: ' + responsePayload.name);
        // console.log('Given Name: ' + responsePayload.given_name);
        // console.log('Family Name: ' + responsePayload.family_name);
        // console.log("Image URL: " + responsePayload.picture);
        // console.log("Email: " + responsePayload.email);
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
